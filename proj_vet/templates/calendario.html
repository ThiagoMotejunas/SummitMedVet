<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Calendário de Palestras</title>
  <link rel="stylesheet" href="/static/style_calendario.css" />
</head>
<body class="cal-body">
  <div class="cal-container">
    <h1 class="cal-title">Calendário de Palestras</h1>

    <div class="cal-header">
      <button id="prevBtn" class="cal-nav">&larr;</button>
      <div id="monthLabel" class="cal-month"></div>
      <button id="nextBtn" class="cal-nav">&rarr;</button>
    </div>

    <div class="cal-legend">
      <span class="dot event"></span><span>Dia com evento</span>
    </div>

    <div class="cal-grid">
      <div class="dow">Dom</div>
      <div class="dow">Seg</div>
      <div class="dow">Ter</div>
      <div class="dow">Qua</div>
      <div class="dow">Qui</div>
      <div class="dow">Sex</div>
      <div class="dow">Sáb</div>
    </div>

    <div id="daysContainer" class="days"></div>

    <a href="/central" class="btn-voltar">Voltar ao Menu</a>
  </div>

  <!-- Modal de detalhes/inscrição -->
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close" id="closeModal">&times;</button>
      <h2 id="modalDate"></h2>
      <div id="eventList"></div>

      <form id="inscricaoForm" class="inscricao-form hidden">
        <h3>Inscrever-se</h3>
        <input type="text" id="nome" placeholder="Seu nome" required />
        <input type="email" id="email" placeholder="Seu e-mail" required />
        <button type="submit" class="btn-inscrever">Confirmar inscrição</button>
      </form>
    </div>
  </div>

  <script>
    const monthLabel = document.getElementById('monthLabel');
    const daysContainer = document.getElementById('daysContainer');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const modal = document.getElementById('modal');
    const closeModal = document.getElementById('closeModal');
    const modalDate = document.getElementById('modalDate');
    const eventList = document.getElementById('eventList');
    const inscricaoForm = document.getElementById('inscricaoForm');

    let current = new Date();
    let eventosCache = []; // eventos do mês atual
    let selectedEventoId = null;
    let selectedDateISO = null;

    const monthNames = [
      'Janeiro','Fevereiro','Março','Abril','Maio','Junho',
      'Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'
    ];

    function pad2(n){ return n.toString().padStart(2,'0'); }

    async function fetchEventos(year, month){
      const res = await fetch(`/api/eventos?year=${year}&month=${pad2(month+1)}`);
      return res.json();
    }

    async function renderCalendar(){
      const year = current.getFullYear();
      const month = current.getMonth();
      monthLabel.textContent = `${monthNames[month]} de ${year}`;

      eventsByDate = {};
      eventosCache = await fetchEventos(year, month);
      eventosCache.forEach(e => {
        eventsByDate[e.date] = eventsByDate[e.date] || [];
        eventsByDate[e.date].push(e);
      });

      daysContainer.innerHTML = '';

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startWeekDay = firstDay.getDay(); // 0 Dom ... 6 Sáb
      const totalDays = lastDay.getDate();

      // Espaços em branco antes do 1º dia
      for(let i=0; i<startWeekDay; i++){
        const cell = document.createElement('div');
        cell.className = 'day empty';
        daysContainer.appendChild(cell);
      }

      // Dias do mês
      for(let d=1; d<=totalDays; d++){
        const dateISO = `${year}-${pad2(month+1)}-${pad2(d)}`;
        const cell = document.createElement('div');
        cell.className = 'day';
        cell.innerHTML = `<span class="num">${d}</span>`;

        if(eventsByDate[dateISO]){
            cell.classList.add('has-event');
            // Mostra o título do primeiro evento diretamente no calendário
            const evento = eventsByDate[dateISO][0];
            const label = document.createElement('div');
            label.className = 'event-label';
            label.textContent = evento.title;
            cell.appendChild(label);

            // Clique abre modal com todos os eventos do dia
            cell.addEventListener('click', () => openModal(dateISO, eventsByDate[dateISO]));
        }

        daysContainer.appendChild(cell);
      }
    }

    function openModal(dateISO, eventos){
      selectedDateISO = dateISO;
      modal.classList.remove('hidden');
      modalDate.textContent = new Date(dateISO).toLocaleDateString('pt-BR');
      eventList.innerHTML = eventos.map(e => `
        <div class="event-item">
          <div>
            <strong>${e.title}</strong><br>
            <small>${e.descricao || ''}</small>
          </div>
          <button class="btn-mini" data-id="${e.id}">Inscrever-se</button>
        </div>
      `).join('');

      inscricaoForm.classList.add('hidden');
      selectedEventoId = null;

      eventList.querySelectorAll('.btn-mini').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedEventoId = parseInt(btn.getAttribute('data-id'));
          inscricaoForm.classList.remove('hidden');
        });
      });
    }

    function closeModalFn(){
      modal.classList.add('hidden');
      eventList.innerHTML = '';
      inscricaoForm.classList.add('hidden');
      selectedEventoId = null;
      selectedDateISO = null;
    }

    prevBtn.addEventListener('click', () => {
      current = new Date(current.getFullYear(), current.getMonth()-1, 1);
      renderCalendar();
    });

    nextBtn.addEventListener('click', () => {
      current = new Date(current.getFullYear(), current.getMonth()+1, 1);
      renderCalendar();
    });

    closeModal.addEventListener('click', closeModalFn);
    modal.addEventListener('click', (e) => {
      if(e.target === modal) closeModalFn();
    });

    inscricaoForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const nome = document.getElementById('nome').value.trim();
      const email = document.getElementById('email').value.trim();
      if(!selectedEventoId) return;

      const res = await fetch(`/api/eventos/${selectedEventoId}/inscrever`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome, email })
      });
      const data = await res.json();
      alert(data.mensagem || 'Inscrição realizada!');
      closeModalFn();
    });

    renderCalendar();
  </script>
</body>
</html>
